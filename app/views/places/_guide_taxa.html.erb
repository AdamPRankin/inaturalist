<%-
  data_attrs = if @taxa
    {
      'data-page' => @taxa.current_page,
      'data-total-pages' =>  @taxa.total_pages,
      'data-total-entries' => @taxa.total_entries,
      'data-current-user-observed-count' => @current_user_observed_count,
      'data-listed-taxa-count' => @listed_taxa_count,
      'data-confirmed-listed-taxa-count' => @confirmed_listed_taxa_count
    }
  else
    {}
  end
  data_attrs.delete_if{|k,v| k == 'data-current-user-observed-count'} if @filter_params.blank?
-%>

<div class="guide_taxa" <%= data_attrs.map{|k,v| "#{k}=\"#{v}\""}.join(' ') %>>
  <% if @taxa.total_pages == 0 -%>
    <div class="noresults meta">
      <% if @filter_params.blank? -%>
        No species have been listed for this place yet!
      <% else %>
        No matching species.
      <% end -%>
    </div>
  <% else %>
    <% for taxon in @taxa %>
      <%-
        listed_taxon = @listed_taxa_by_taxon_id[taxon.id]
        cache_key = "guide_taxon_#{listed_taxon.try(:id)}_#{taxon.try(:id)}"
      -%>
      <%- cache cache_key, :expires_in => 30.minutes do %>
        <%= render :partial => "listed_taxa/guide_taxon", :locals => { :listed_taxon => listed_taxon, :taxon => taxon } %>
      <% end -%>
    <% end %>
    <%= will_paginate @taxa %>
  <% end -%>
  <script type="text/javascript" charset="utf-8">
    var newTaxa = <%= @taxa_by_taxon_id.to_json(:methods => [:common_name]) %>
    if (taxa) {
      $.extend(taxa, newTaxa)
    } else {
      var taxa = newTaxa
    }
  </script>
</div>
