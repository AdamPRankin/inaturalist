<%- content_for(:title) do -%>
  Places
<%- end -%>

<%- content_for(:extracss) do -%>
  <style type="text/css" media="screen">
    #map { width: 100%; height: 600px; }
    #mapcol h3 { margin-bottom: 0; position: relative; }
    #places { position: absolute; top: 475px; text-align:center; left: 50%; margin-left: -425px; width: 850px; padding: 10px; }
    #places .place { background-color: white; text-align: left; vertical-align: top; box-shadow: #888 0px 0px 5px; background-color: white; margin: 5px; opacity: 0.8; }
    #places .place:hover { opacity: 1; }
    #places .placeinfo { padding: 5px 10px 10px 10px; }
    #searchform { margin-top: 8px; }
  </style>
<%- end -%>

<%- content_for(:extrajs) do -%>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <%= javascript_include_tag 'inaturalist/map3' %>

  <script type="text/javascript" charset="utf-8">
    var TILESTACHE_SERVER = <%= INAT_CONFIG['tile_servers']['tilestache'].inspect %>,
        places = <%= @places.to_json %>
    $(document).ready(function() {
      window.map = iNaturalist.Map.createMap({
        lat: 0, 
        lng: 0, 
        zoom: 2,
        minZoom: 2
      })
      for (var i=0; i < places.length; i++) {
        var place = places[i]
        var icon = iNaturalist.Map.createPlaceIcon({color: 'DodgerBlue', character: i+1})
        var marker = map.createMarker(place.latitude, place.longitude, {icon: icon})
        google.maps.event.addListener(marker, 'click', function() {
          window.location = '/places/'+place.id
        })
        marker.setMap(map)
      }
      if (TILESTACHE_SERVER) {
        var placesMapType = iNaturalist.Map.builtPlacesMapType(map, {tilestacheServer: TILESTACHE_SERVER})
        map.overlayMapTypes.insertAt(0, new placesMapType(new google.maps.Size(256, 256)));
      }
    })
  </script>
<%- end -%>

<div id="pageheader" class="column span-24">
  <div id="searchform" class="clear right buttonrow smallbuttons">
    <%= render :partial => 'places/search_form', :locals => {:q => ''} %>
  </div>
  <h2>
    Places&nbsp;
    <span class="small description">
      Find a new place to explore!
    </span>
  </h2>
</div>

<div id="mapcol" class="stacked column span-24">
  <div id="map"></div>
  <div id="places">
    <% @places.each_with_index do |place, i| %>
      <div class="place inlineblock span-4">
        <%= link_to(
          google_static_map_for_place(
            place, 
            {
              :zoom => map_zoom_for_place(place, 150, 93),
              :size => '150x93', 
              :maptype => 'satellite', 
              :markers => "color:blue|label:#{i+1}|#{place.latitude},#{place.longitude}"}, 
            :class => 'map'
          ), place) %>
        <div class="placeinfo">
          <h3>
            <%= link_to h(truncate(place.name, :length => 30)), place %>
          </h3>
          <div class="small description">
            <%= place.place_type_name %>
            <% if place.parent -%>
              in <%= link_to place.parent.display_name, place.parent %>
            <% end -%>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>



<div id="aboutcol" class="column span-24">
  <div class="column span-16">
    <h3>About Places</h3>
    <p>
      The world is full of interesting places, each filled with weird and
      wonderful life forms. Some are on the other side of the world, while
      others are just down the street!
    </p>

    <p>
      iNaturalist Places are a way to record what lives where. If you're
      looking for a particular species, you'll know where to search. Each
      place has a check list to record all the species that occur there, so
      they can also be useful for looking up things you've found at particular
      spots.
    </p>
  </div>
  <div class="last column span-8">
    <div class="clear box">
      <p class="ui description">
        You can help out by <%= link_to "adding new places", new_place_path, :rel => "nofollow" %>
        and filling in check lists for the places you know!
      </p>
      <%= link_to "Add a New Place", new_place_path, :class => 'button readmore right', :rel => "nofollow" %>
    </div>
  </div>
</div>