<li class="col-md-3">
  <div class="thumbnail">
    <% photo_count, sound_count, link_text =
      observation.observation_photos_finished_processing.size,
      observation.observation_sounds_count, [] %>
    <% if photo_count == 0 && sound_count == 0 -%>
      <%= link_to observation_path(observation), :class => "no_photo_sound" do %>
        <i class="icon icon-iconic-<%= observation.iconic_taxon.nil? ? 'unknown' : observation.iconic_taxon.name.downcase %>" style="font-size: 105px; color:rgb(238,238,238);"></i>
      <% end -%>
    <% else %>
      <% if photo_count > 0 %>
        <%- 
          photos = observation.observation_photos_finished_processing.sort_by{|op|
            op.position || photo_count + op.id.to_i
          }.map{|op| op.photo}.compact
          photo = photos.first
        %>
        <% if photo %>
          <%= link_to observation_path(observation) do %>
            <div class="scaledimg" style="background-image: url('<%= "#{photo.small_url}" %>')"></div>
          <% end %>
        <% end %>
      <% end -%>
      <% if sound_count > 0 %>
        <%= link_to '<i class="fa fa-volume-up fa-4x"></i>'.html_safe, observation_path(observation), :class => "sound-icon#{' with-photo' if photo}" %>
        <% if sound_count > 1 %>
          <% link_text << t(:'sounds.sounds_size_sounds', :sounds_size => sound_count).downcase %>
        <% end -%>
      <% end %>
    <% end -%>
    <h3>
      <% if observation.taxon %>
        <%= render :partial => 'shared/taxon', 
                   :locals => {
                      :taxon => observation.taxon,
                      :link_url => observation_path(observation),
                      :include_parens => false,
                      :truncate => true,
                      :trunclength => 20,
                      :one_name => true} %>
      <% else %>
        <span class="taxon">
          <%= link_to "#{t(:unknown)}", observation_path(observation) %>
        </span>
      <% end %>
    </h3>
  </div>
</li>