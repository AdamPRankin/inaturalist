<% content_for(:title) do -%>
  <%= t(:your_home) %>
<% end -%>
<% content_for(:extracss) do -%>
  <%= stylesheet_link_tag 'identifications', "lists", 'lists/show_listed_taxa', 'dashboard' %>
<% end -%>

<%- content_for(:extrajs) do -%>
  <%= google_maps_js %>
  <%= javascript_include_tag 'map_bundle', "d3.min", 'calendars', 'observations/observation_fields' %>
  <script type="text/javascript" charset="utf-8">
    var CACHED_AT = new Date(<%= Time.now.to_i * 1000 %>)
    $(document).ready(function() {
      $('#tabs').tabs({
        show: function(event, ui) {
          if ($(ui.panel).attr('id') == 'comments' && !$(ui.panel).hasClass('loaded')) {
            $(ui.panel).load('/comments?partial=true', function(data) {
              var html = data.replace(/[\s\n]+/, ' ')
              $(this).html(html)
            })
          }
          $(ui.panel).addClass('loaded')
        }
      })
      
      $('.subscriptionsettings').subscriptionSettings()
      $('abbr.timeago').timeago()
      if ((new Date()).getTime() - CACHED_AT.getTime() > 5000) {
        $('#flash').hide()
      }
      var dayInSeconds = 24 * 60 * 60,
          now = new Date(),
          monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
      
      var elt = $('abbr.compact.date:first')
      if (elt.length > 0) {
        var dateString = $(elt).attr('title').split('T')[0],
            timeString = $(elt).attr('title').split('T')[1],
            d = new Date(Date.parse($(elt).attr('title')))

        $('abbr.compact.date').each(function() {
          var dateString = $(this).attr('title').split('T')[0],
              timeString = $(this).attr('title').split('T')[1],
              d = new Date(Date.parse($(elt).attr('title')))
          if (!timeString.indexOf(':') || typeof(d) != 'object') { return }
          if (now.getFullYear() == d.getFullYear() &&
              now.getMonth() == d.getMonth() &&
              now.getDate() == d.getDate()) {
            return 
          }
          $(this).html(monthNames[d.getMonth()] + ' ' + d.getDate())
        })
      }

      $('#new_place_subscription_link, #new_taxon_subscription_link').click(function() {
        var dialogId = 'new_subscription_dialog'
        var dialog = $('#'+dialogId)
        if (dialog.length != 0) {$(dialog).remove()};
        dialog = $('<div></div>')
          .attr('id', dialogId)
          .addClass('dialog').html('<div class="loading status">' + I18n.t('loading') + '</div>')
        $(document).append(dialog)
        var data = 'partial=form&authenticity_token=' + $('meta[name=csrf-token]').attr('content')
        dialog.load($(this).attr('href'), data, function() {
          $(this).centerDialog()
          $('form:has(input[required])', this).submit(checkFormForRequiredFields)
        })
        dialog.dialog({
          modal: true,
          title: 'Subscribe to a new place/taxon'
        })
        return false
      })
    })
  </script>
<%- end -%>

<div class="container" style="background-color:white">
  <% if announcement = @announcements.detect{|a| a.placement == 'users/dashboard'} -%>
    <div class="column span-24">
      <%= announcement.body.html_safe %>
    </div>
  <% end -%>
  
  <%= render :partial => "shared/by_login_header_bootstrap", :locals => { :user => current_user } %>

  <div class="col-md-8"  style="background-color:white">
    <div class="tabbable">
      <ul class="nav nav-pills">
  	  	<li class="<%= 'active' if params[:filter].blank? %>" >
          <% if params[:filter].blank? %>
            <a href="#updates" data-toggle="tab"><%= t(:following).capitalize %></a>
          <% else %>
            <%= link_to t(:following).capitalize, dashboard_path %>            
          <% end %>
        </li>
  		  <li class="<%= 'active' if params[:filter] == 'you' %>" >
          <% if params[:filter] == 'you' %>
            <a href="#updates" data-toggle="tab"><%= t(:you).capitalize %></a>
          <% else %>
            <%= link_to t(:you).capitalize, dashboard_path(:filter => "you") %>
          <% end %>
        </li>
  		  <li><a href="#comments" data-toggle="tab"><%= t :comment_feed %></a></li>
  	  </ul>
      <div class="tab-content">
        <div class="tab-pane active" id="updates">  
          <p><%= current_user.last_ip %>, <%= current_user.latitude %>, <%= current_user.longitude %>, <%= current_user.login %></p>
          <% if current_user.observations_count == 0 -%>
            <div class="panel panel-success">
              <div class="panel-heading">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h3 class="panel-title" style="font-size:20px">Let's Get Started      </h3>
              </div>
              <div class="panel-body">
                <div class="media">
                  <div class="media-body">
                    <p class="lead">Get outside and observe an individual organism. Pick something wild and take a clear, full frame photo. If you already have a photo of something wild, <a href="http://www.inaturalist.org/observations/new">add it now</a>. </p>
                    <p>You can also use iNaturalist mobile apps to share your observation with the community. Check back for activity on your observation to discuss your encounter and who knows what you'll discover!</p>
                  </div>
                  <div class="media-right"> <a href="#"> <img class="media-object"  src="http://thinkmoredesign.com/inat/Getting_Started/img/take_r_circle.jpg" alt="..." style="padding: 0 0 0 10px"> </a> </div>
                </div>
              </div>
              <div class="panel-footer">
                <a href="http://www.inaturalist.org/observations" class="btn btn-primary btn-md" role="button">
                  Browse  Observations<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                </a>
                <a href="http://www.inaturalist.org/pages/getting+started" target="_blank" class="" role="button">
                  <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> Getting Started Guide
                </a>
              </div>        
            </div>
          <% end -%>
      
          <% if current_user.friendships.count == 0 -%>
            <div class="panel panel-success">
              <div class="panel-heading">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h3 class="panel-title"> Follow Some Active Naturalists</h3>
              </div>
              <div class="panel-body">
                <div class="row">
                  <% @followers.each do |friend| %>
                    <%= render(:partial => 'followees', :locals => {:friend => friend}) %>
                  <% end %>
                </div>

              </div>
              <div class="panel-footer"><a href="http://www.inaturalist.org/people" class="btn btn-primary" role="button">Browse People <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a></div>
            </div>                
          <% end -%> 
            
          <% if @updates.blank? -%>
            <p>
            <%= t :no_more_updates %>
            </p>
          <% else %>
            <% for key, updates in @grouped_updates %>
              <%-
                resource_type, resource_id, notification = key
                resource = if @update_cache && @update_cache[updates.last.resource_type.underscore.pluralize.to_sym]
                  @update_cache[updates.last.resource_type.underscore.pluralize.to_sym][updates.last.resource_id]
                else
                  updates.last.resource
                end
                notifier = if @update_cache && @update_cache[updates.last.notifier_type.underscore.pluralize.to_sym]
                  @update_cache[updates.last.notifier_type.underscore.pluralize.to_sym][updates.last.notifier_id]
                else
                  updates.last.notifier
                end
                is_mention = (notification == "mention")
              -%>
              <div class="update clear stacked <%= 'activity' if updates.last.notification == 'activity' %> <%= 'new' if updates.detect{|u| !u.new_record? && u.viewed_at.blank?} && updates.last.resource_owner_id == current_user.id %>">
                <div class="updateresource">
                <%= link_to update_image_for(updates.last), resource %>
              </div>
                <div class="updatebody">
                <div class="updateheader meta stacked">
                  <div class="right small">
                    <abbr class="compact date" title="<%= updates.last.sort_by_date.iso8601 %>"><%= compact_date(updates.last.sort_by_date) %></abbr>
                    <%- if is_mention %>
                      <%= link_to "<span class='ui-icon inlineblock ui-icon-gear'>Settings</span>".html_safe,
                        "#", class: "subscriptionsettings", "data-gear-text" => I18n.t("edit_your_default_settings"),
                        "data-gear-url" => generic_edit_user_url %>
                    <%- else %>
                      <%= link_to "<span class='ui-icon inlineblock ui-icon-gear'>Settings</span>".html_safe,
                        edit_subscription_by_resource_path(resource_type, resource_id),
                        class: "subscriptionsettings" %>
                    <%- end %>
                  </div>
                  <%= update_tagline_for(updates.last, :count => updates.size) %>
                </div>
                <% if notification == "activity" || is_mention -%>
                  <div class="updatecontent">
                    <% for u in updates %>
                      <%-
                        notifier = nil
                        if @update_cache && @update_cache[u.notifier_type.underscore.pluralize.to_sym]
                          notifier = @update_cache[u.notifier_type.underscore.pluralize.to_sym][u.notifier_id]
                        end
                        notifier ||= u.notifier
                      -%>
                      <div id="<%= dom_id(u) unless u.new_record? %>" class="<%= 'stub' if u.new_record? %>">
                        <%= render partial: "shared/activity_item", object: notifier, locals: { no_thumb: (is_mention && notifier.is_a?(Post)), no_meta: is_mention, context_around: is_mention ? "@#{ current_user.login }" : nil } %>
                      </div>
                    <% end %>
                    <%= link_to "#{t(:view)} #{t(resource.class.to_s.underscore.humanize, :default => resource.class.to_s.underscore.humanize).downcase}",
                              resource, :class => "readmore" %>
                  </div>
                <% else %>
                  <%= 
                    begin
                      render :partial => "#{resource_type.underscore.pluralize}/update_#{notification}", 
                        :object => resource, :locals => {:updates => updates, :resource => resource}
                      rescue ActionView::MissingTemplate, Errno::ENOENT
                        "#{resource_type} #{notification}"
                    end
                  -%>
                <% end -%>
              </div>
              </div>
            <% end %>
            <script type="text/javascript" charset="utf-8">
              $('.observationcontrols').observationControls()
            </script>
            <div class="pagination">
              <%= link_to(t(:more), url_for_params(:from => @pagination_updates.last.id), :class => "btn btn-sm btn-default") unless @pagination_updates.blank? %>
            </div>
          <% end %>
        </div>
        <div class="tab-pane" id="comments">
          <%= loading %>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4"  style="padding-left:25px">
    <%= link_to new_observation_path, :id => "obsbutton", :class => "btn btn-default btn-lg  nav-justified" do %>
      <span class="glyphicon glyphicon-plus"></span>
      <%= t(:add_observations) %>
    <% end %>
    
    <% if (announcement = @announcements.detect{|a| a.placement == 'users/dashboard#sidebar'}) && !user_seen_announcement?(announcement) -%>
      <%= announcement.body.html_safe %>
    <% end -%>

    <h3 class="page-header">
    <%= t :subscriptions %>
    <% helptip_for "subscriptions" do %>
      <%= t :subscribe_to_places_to %>
    <% end -%>
    </h3>
    
    <ul style="margin-bottom: 5px" class="plain">
      <% unless @subscriptions.blank? %>
        <% for resource_type, subscriptions in @subscriptions.group_by(&:resource_type) %>
          <li>
            <span class="meta"><%= t(resource_type.humanize.pluralize.downcase, :default => resource_type.humanize.pluralize) %></span>
            <ul style="margin-bottom: 5px">
              <% for subscription in subscriptions %>
                <li class="subscription_for_<%= [subscription.resource_type, subscription.resource_id].join('_') %>">
                  <%= link_to subscription.resource.try_methods(:display_name, :name, :title), subscription.resource %>
                  <nobr class="meta">
                    <% if subscription.taxon -%>
                      (<%= subscription.taxon.name %>)
                    <% end -%>
                    <%= link_to t(:edit), edit_subscription_path(subscription), :class => "small subscriptionsettings" %>
                  </nobr>
                </li>
              <% end %>
            </ul>
          </li>
        <% end %>
      <% end -%>
    </ul>
        
    <div class="list-group">
      <%= link_to new_subscription_path(:type => "place"), :id => "new_place_subscription_link", :class => "list-group-item" do %>
        <span class="glyphicon glyphicon-map-marker"></span>
        Follow a Place
      <% end -%>
      <%= link_to new_subscription_path(:type => "taxon"), :id => "new_taxon_subscription_link", :class => "list-group-item" do %>
        <span class="glyphicon glyphicon-leaf"></span>
        Follow a Species
      <% end -%>
      <%= link_to subscriptions_path, :class => "list-group-item" do %>
        <span class="glyphicon glyphicon-wrench"></span>
        Manage Subscriptions
      <% end -%>
    </div>
    
    <h3 class="page-header">More...</h3>
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Getting Started Guide <button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span></button></h3>
      </div>
      <div class="panel-body">
        <p>Let us walk you through the main features of this site.</p>
        <p><a href="/pages/getting+started" class="btn btn-default btn-md" role="button">Get Started</a></p>
      </div>
    </div>
      
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Blog Widget</h3>
      </div>
      <div class="panel-body">
        <p><%= t :show_off_your_recent_observations %></p>
        <p>
          <%= link_to t(:learn_more), {:controller => "observations", :action => "widget"}, :class => "btn btn-default btn-md" %>
        </p>
      </div>
    </div>

    <% if current_user.is_curator? -%>
      <div id="curatorbox" class="box">
          <h3>
            <%= t :curation %>
            <% helptip_for "curation" do %>
              <%= t :youre_a_site_curator_which_means %>
              <%= link_to CONFIG.help_email, "mailto:#{CONFIG.help_email}" %>.
            <% end -%>
          </h3>
          <% unless @flags.blank? -%>
            <h4>
              <%= t(:flag).pluralize %>
              <% helptip_for "flags" do %>
                <%= t :these_are_items_people_on %> <%=
                CONFIG.help_email %>.
              <% end -%>
            </h4>
            <ul>
              <% for flag in @flags %>
                <li>
                  <%= render :partial => "flags/flag", :object => flag %>
                </li>
              <% end %>
            </ul>
          <% end -%>

          <% unless @ungrafted_taxa.blank? -%>
            <h4>
              <%= t :ungrafted_taxa %>
                <% helptip_for "ungrafted_taxa" do %>
                  <%=raw t :these_are_taxa_that, :site => CONFIG.site_name_short %>
                <% end -%>
            </h4>
            <ul>
              <% for taxon in @ungrafted_taxa %>
                <li>
                  <%= link_to_taxon taxon %>
                  <%= link_to t(:edit), edit_taxon_path(taxon) %>
                </li>
              <% end %>
            </ul>
          <% end -%>

          <%= link_to t(:curate_taxa), curate_taxa_path %> |
          <%= link_to t(:create_a_new_taxon), new_taxon_path %>
        </div>
    <% end -%>
    
  </div>
</div>
