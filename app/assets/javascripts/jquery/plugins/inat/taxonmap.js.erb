(function($){
  $.fn.taxonMap = function(options) {
    options = options || {}
    $(this).each(function() {
      if (options == 'fit') {
        fit(this)
      } else {
        setup(this, options)
      }
    })
  }

  function setup(elt, options) {
    var options = $.extend({}, options)
    if (options.taxon) {
      options.taxonId = options.taxon.id
    } else {
      options.taxonId = options.taxonId || $(elt).attr('data-taxon-id')
    }
    if (!options.taxonId) { return }
    options.iconicTaxonName = options.iconicTaxonName || $(elt).attr('data-iconic-taxon-name')
    options.latitude = options.latitude || $(elt).attr('data-latitude')
    options.longitude = options.longitude || $(elt).attr('data-longitude')
    options.mapType = options.mapType || $(elt).attr('data-map-type')
    var zoomLevel = parseInt(options.zoomLevel || $(elt).attr('data-zoom-level'))
    options.zoomLevel = zoomLevel == 0 ? null : zoomLevel
    options.gbifKmlUrl = options.gbifKmlUrl || $(elt).attr('data-gbif-kml')
    if (options.gbifKmlUrl == '') { options.gbifKmlUrl = null }
    options.taxonRangeCitation = options.taxonRangeCitation || $(elt).attr('data-taxon-range-citation')
    options.taxonRangeCitationUrl = options.taxonRangeCitationUrl || $(elt).attr('data-taxon-range-citation-url')
    options.observationsJsonUrl = options.observationsJsonUrl || $(elt).attr('data-observations-json')
    options.rangeTaxonID = options.rangeTaxonID || $(elt).attr('data-range-taxon-id')
    options.placeGeomID = options.placeGeomID || $(elt).attr('data-place-geom-id')

    if (options.observationsJsonUrl != false) {
      options.observationsJsonUrl = options.observationsJsonUrl
        || $(elt).attr('data-observations-json')
    }
    options.bbox = options.bbox || $(elt).attr('data-bbox')
    if (typeof(options.bbox) == 'string') {
      options.bbox = $.map(options.bbox.split(','), Number)
    }
    $(elt).data('taxonMapOptions', options)
    // if ($.browser.msie && typeof(google) != 'undefined') {
    if (true) {
      setupGoogle(elt)
    } else if (typeof(org) != 'undefined' && typeof(org.polymaps) != 'undefined') {
      setupPolymaps(elt)
    }
  }

  function fit(elt) {
    if (true) {
      fitGoogle(elt)
    } else if (typeof(org) != 'undefined' && typeof(org.polymaps) != 'undefined') {
      fitPolymaps(elt)
    }
  }

  function setupGoogle(elt) {
    var options = $(elt).data('taxonMapOptions'),
        map = iNaturalist.Map.createMap({div: elt}),
        preserveViewport = options.preserveViewport
    window.map = map;
    if (options.bbox) {
      map.fitBounds(
        new google.maps.LatLngBounds(
          new google.maps.LatLng(options.bbox[0], options.bbox[1]),
          new google.maps.LatLng(options.bbox[2], options.bbox[3])
        )
      )
      preserveViewport = true
    } else if (options.latitude || options.longitude) {
      map.setCenter(new google.maps.LatLng(options.latitude || 0, options.longitude || 0))
      if (options.zoomLevel) {
        map.setZoom(options.zoomLevel)
      }
    }

    if (options.mapType) {
      map.setMapTypeId(options.mapType)
    }

    if (options.gbifKmlUrl) {
      var gbifLyr = new google.maps.KmlLayer(options.gbifKmlUrl, {suppressInfoWindows: true, preserveViewport: true})
      map.addOverlay(I18n.t('taxon_map.gbif_occurrences'), gbifLyr, {
        id: 'gbif-'+options.taxonId,
        hidden: true,
        description:
          I18n.t('taxon_map.it_may_take_google_a_while_to') +
          ' <a target="_blank" href="'+options.gbifKmlUrl.replace(/&format=kml/, '')+'">' + I18n.t('taxon_map.data_url') + '</a>'
      })
      google.maps.event.addListener(gbifLyr, 'click', function(e) {
        if (!window['kmlInfoWindows']) window['kmlInfoWindows'] = {}
        for (var k in window['kmlInfoWindows']) {
          window['kmlInfoWindows'][k].close()
        }
        var win = window['kmlInfoWindows'][e.featureData.id]
        if (!win) {
          // filter out google's insane parsing
          var content = (e.featureData.description || '').replace(/(<a.+?>)<a.+?>(.+?)<\/a><\/a>/g, "$1$2</a>")
          content = content.replace(/&lt;\/a/g, '')
          content = content.replace(/&gt;/g, '')
          content = content.replace(/<\/a"/g, '"')
          win = window['kmlInfoWindows'][e.featureData.id] = new google.maps.InfoWindow({
            content: content,
            position: e.latLng,
            pixelOffset: e.pixelOffset
          })
        }
        win.open(window.map)
        return false
      })
      preserveViewport = true
    }

    if (options.rangeTaxonID) {
      map.addTaxonRangeLayer({ taxon_id: options.rangeTaxonID });
    }

    if (options.placeGeomID) {
      map.addPlaceLayer({ place_id: options.placeGeomID });
    }

    if (options.observationsJsonUrl) {
      $.get(options.observationsJsonUrl, function(data) {
        map.addObservations(data)
        if (!preserveViewport && map.observationBounds) {
          map.zoomToObservations()
          preserveViewport = true
        }
      })
    } else if (options.taxonId) {
      gridOptions = { taxon_id: options.taxonId };
      if (options.iconicTaxonName) {
        gridOptions['grid_color'] = iNaturalist.Map.ICONIC_TAXON_COLORS[options.iconicTaxonName];
      }
      window.map.addObservationsLayer(gridOptions);
    }

    if (!preserveViewport) {
      fit(elt)
    }

    var overlayControlDiv = document.createElement('DIV')
    map._overlayControl = new iNaturalist.OverlayControl(map, {div: overlayControlDiv})
    map.controls[$(elt).width() < 300 ? google.maps.ControlPosition.LEFT_TOP : google.maps.ControlPosition.TOP_RIGHT].push(overlayControlDiv)

    $(elt).data('taxonMap', map)
  }

  function setupPolymaps(elt) {

  }

  function fitGoogle(elt) {
    var options = $(elt).data('taxonMapOptions'),
        map = $(elt).data('taxonMap'),
        preserveViewport = false
    if (!map) {return};
    if (options.bbox) {
      map.fitBounds(
        new google.maps.LatLngBounds(
          new google.maps.LatLng(options.bbox[0], options.bbox[1]),
          new google.maps.LatLng(options.bbox[2], options.bbox[3])
        )
      )
      return
    } else if (options.latitude || options.longitude) {
      map.setCenter(new google.maps.LatLng(options.latitutde || 0, options.longitude || 0))
      map.setZoom(4)
      return
    }

    if (options.observationsJsonUrl && map.observationBounds) {
      map.zoomToObservations()
      return
    }

    map.setCenter(new google.maps.LatLng(0, 0))
    map.setZoom(1)
  }

  function observationsJsonUrl(id) {
    return '//' + window.location.host + '/observations/of/'+id+'.json'
  }
}(jQuery))
