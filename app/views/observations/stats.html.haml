= content_for(:title) do
  Real time stats for
  = [@place.try(:name), @user.try(:login), @project.try(:title)].compact.join(' / ')
#stats.clear
  #count.stat.numerical
    .count ?
    observations
  #species.stat.numerical
    .count ?
    species
  #people.stat.numerical
    .count ?
    people
  #most_observed.stat
    %label Most observed species
    %table
      %tr
        %td.image= image_tag('iconic_taxa/unknown-32px.png')
        %td.taxon
          .meta Unknown
  #most_observations.stat
    %label Most observations
    %table
      %tr
        %td.image= image_tag('/attachment_defaults/users/icons/defaults/thumb.png')
        %td.user
          .meta Unknown
  #most_species.stat
    %label Most species
    %table
      %tr
        %td.image= image_tag('/attachment_defaults/users/icons/defaults/thumb.png')
        %td.user
          .meta Unknown

- if @stats_adequately_scoped
  #observations.observations.medium.grid
    = loading
  = link_to t(:view_all_observations), request.path.gsub(/stats\//, ''), :class => "readmore"
- else
  You must add one of the following parameters to the URL to use this tool
  %ul
    %li
      %code place_id
      %div
        Example:
        %code= stats_observations_url(:place_id => 'belgium')
    %li
      %code user_id
      %div
        Example:
        %code= stats_observations_url(:user_id => 1)
    %li
      %code projects
      %div
        Example:
        %code= stats_observations_url(:projects => 10)
    %li
      %code d1
      and
      %code d2
      (max date range 1 year)
      %div
        Example:
        %code= stats_observations_url(:d1 => "2012-01-01", :d2 => "2012-01-30")

= content_for(:extracss) do
  :css
    .stat {float:left;margin-right: 20px;}
    .stat .count {font-size: 300%;}
    #wrapper { width: auto; padding: 0 10px; position: relative;padding:10px;}
    .stat img {max-width:32px;}
    .numerical.stat {text-align: center;}
    .numerical.stat .count {line-height: 1;}
    td {border:none; vertical-align:top;}
    table {margin:0;}

:javascript
  function refreshObservations() {
    var url = '/observations'+window.location.search+'&partial=cached_component'
    var req
    req = $.ajax({
      type: "GET",
      url: url,
      success: function (data, status) {
        window.headers = req.getAllResponseHeaders()
        var html = data.replace(/\/div>[\s\n]+?<div/g, '/div><div')
        var oldObsId = $('#observations .observation:first').attr('id')
        if (oldObsId) {
          var r = new RegExp('^[^>]+'+oldObsId, 'g')
          if (r.test(html)) {
            return
          }
        }
        $('#observations').html(html)
        $('#observations').observationsGrid('medium')
        var matches = headers.match(/X-Total-Entries: (\d+)/) || [],
            totalEntries = matches[1]
        if (totalEntries) {
          $('#count .count').html(totalEntries)
        }
      }
    })
    setTimeout('refreshObservations()', 10*1000)
  }
  if ($('#observations').length == 1) { refreshObservations() }

  function refreshTaxa() {
    var url = '/observations/taxon_stats.json'+window.location.search
    $.getJSON(url, function(json) {
      $('#species .count').html(json.rank_counts.species || 0)
      if (json.taxon_counts.length > 0) {
        var most
        for (var i = 0; i < json.taxon_counts.length; i++) {
          if (json.taxon_counts[i].taxon) {
            most = json.taxon_counts[i]
            break
          }
        };
        $('#most_observed .taxon').html(
          $('<a></a>').
            addClass('nobr '+most.taxon.default_name.lexicon).
            attr('href', '/taxa/'+most.id).
            html(most.taxon.default_name.name)
        )
        $('#most_observed .image img').attr('src', most.taxon.image_url)
        $('#most_observed .taxon').append(
          $('<div class="meta"></div>').append(
            $('<a></a>').
              attr('href', '/observations'+window.location.search+'&taxon_id='+most.id).
              html(most.count),
            ' observation'+(most.count == 1 ? '' : 's')
          )
        )
      }
      setTimeout('refreshTaxa()', 10*1000)
    })
  }
  if ($('#observations').length == 1) { refreshTaxa() }

  function refreshUsers() {
    var url = '/observations/user_stats.json'+window.location.search
    $.getJSON(url, function(json) {
      $('#people .count').html(json.total || 0)
      if (json.most_observations.length > 0) {
        var most = json.most_observations[0],
            img_url = most.user.user_icon_url || '/attachment_defaults/users/icons/defaults/thumb.png'
        $('#most_observations .image img').attr('src', img_url)
        $('#most_observations .user').html($('<a>'+most.user.login+'</a>').attr('href', '/people/'+most.id))
        $('#most_observations .user').append(
          $('<div></div>').addClass('meta').html(most.count + " observations")
        )
      }
      if (json.most_species.length > 0) {
        most = json.most_species[0]
        img_url = most.user.user_icon_url || '/attachment_defaults/users/icons/defaults/thumb.png'
        $('#most_species .image img').attr('src', img_url)
        $('#most_species .user').html($('<a>'+most.user.login+'</a>').attr('href', '/people/'+most.id))
        $('#most_species .user').append(
          $('<div></div>').addClass('meta').html(most.count + " species")
        )
      }
      setTimeout('refreshUsers()', 20*1000)
    })
  }
  if ($('#observations').length == 1) { refreshUsers() }
